<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整技能樹系統測試 - Step 2.1 整合版</title>
    
    <style>
        :root {
            /* 基礎色彩 */
            --primary-dark: #0a0a0a;
            --secondary-dark: #1a1a2e;
            --primary-gold: #d4af37;
            --bright-gold: #f4d03f;
            --primary-blue: #2980b9;
            --primary-green: #2ecc71;
            --primary-red: #e74c3c;
            
            /* 技能狀態色彩 */
            --skill-locked-color: #555;
            --skill-available-color: #3498db;
            --skill-learning-color: #2ecc71;
            --skill-mastered-color: #f4d03f;
            
            /* 響應式變數 */
            --skill-size: 60px;
            --skill-spacing: 120px;
            --layout-transition-duration: 600ms;
            
            /* 響應式斷點 */
            --mobile: 768px;
            --tablet: 1024px;
            --desktop: 1200px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        /* 頂部信息欄 */
        .info-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--primary-gold);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-header h1 {
            color: var(--bright-gold);
            font-size: 20px;
            font-weight: bold;
        }
        
        .info-header .version {
            color: var(--primary-blue);
            font-size: 12px;
        }
        
        .system-status {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-red);
        }
        
        .status-indicator.ready {
            background: var(--primary-green);
        }
        
        .status-indicator.loading {
            background: var(--primary-gold);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* 控制面板 */
        .control-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1500;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary-gold);
            border-radius: 12px;
            padding: 20px;
            min-width: 320px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .control-panel h3 {
            color: var(--bright-gold);
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #ccc;
            font-weight: bold;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .button-grid.single {
            grid-template-columns: 1fr;
        }
        
        .control-button {
            padding: 10px 12px;
            background: linear-gradient(135deg, var(--primary-blue), #2c3e50);
            border: 1px solid var(--primary-blue);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .control-button:hover {
            background: linear-gradient(135deg, var(--bright-gold), #d35400);
            border-color: var(--bright-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 208, 63, 0.3);
        }
        
        .control-button:active {
            transform: translateY(0);
        }
        
        .control-button.active {
            background: linear-gradient(135deg, var(--bright-gold), #f39c12);
            border-color: var(--bright-gold);
            color: var(--primary-dark);
        }
        
        /* 統計面板 */
        .stats-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1500;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary-gold);
            border-radius: 12px;
            padding: 15px;
            min-width: 280px;
        }
        
        .stats-panel h3 {
            color: var(--bright-gold);
            margin-bottom: 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 11px;
        }
        
        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-label {
            color: #ccc;
            display: block;
            margin-bottom: 3px;
        }
        
        .stat-value {
            color: var(--bright-gold);
            font-weight: bold;
            font-size: 13px;
        }
        
        /* 技能樹容器 */
        .skill-tree-main {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        
        .skill-tree-container {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: grab;
            background: 
                radial-gradient(circle at 25% 25%, rgba(244, 208, 63, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(52, 152, 219, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
        }
        
        .skill-tree-container.dragging {
            cursor: grabbing;
        }
        
        .skill-tree-content {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            will-change: transform;
        }
        
        /* 技能節點樣式 */
        .skill-node {
            position: absolute;
            width: var(--skill-size);
            height: var(--skill-size);
            border-radius: 50%;
            border: 3px solid var(--skill-locked-color);
            background: 
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2), rgba(255,255,255,0.05)),
                radial-gradient(circle, rgba(0,0,0,0.1), rgba(0,0,0,0.4));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            color: white;
            cursor: pointer;
            user-select: none;
            transition: all var(--layout-transition-duration) cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.4;
            z-index: 10;
        }
        
        .skill-node:hover {
            transform: scale(1.15);
            z-index: 20;
        }
        
        .skill-node:focus {
            outline: 2px solid var(--bright-gold);
            outline-offset: 4px;
        }
        
        /* 技能狀態樣式 */
        .skill-node.skill-status-locked {
            border-color: var(--skill-locked-color);
            opacity: 0.4;
        }
        
        .skill-node.skill-status-available {
            border-color: var(--skill-available-color);
            opacity: 0.8;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.4);
        }
        
        .skill-node.skill-status-learning {
            border-color: var(--skill-learning-color);
            opacity: 0.7;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.4);
        }
        
        .skill-node.skill-status-mastered {
            border-color: var(--skill-mastered-color);
            opacity: 1.0;
            box-shadow: 0 0 20px rgba(244, 208, 63, 0.6);
        }
        
        /* 技能連接線 */
        .skill-connection {
            position: absolute;
            background: linear-gradient(90deg, transparent 10%, var(--primary-blue) 50%, transparent 90%);
            height: 2px;
            opacity: 0.3;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1;
        }
        
        .skill-connection.highlighted {
            opacity: 0.8;
            height: 3px;
            filter: drop-shadow(0 0 5px var(--primary-blue));
        }
        
        /* 分支頭部 (移動端) */
        .skill-branch-header {
            position: absolute;
            background: rgba(26, 26, 46, 0.9);
            border: 2px solid var(--primary-gold);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(8px);
            transition: all var(--layout-transition-duration) ease;
        }
        
        .skill-branch-header h3 {
            color: var(--bright-gold);
            font-size: 14px;
            margin: 0;
        }
        
        .skill-branch-header .skill-count {
            color: #ccc;
            font-size: 12px;
        }
        
        .collapse-toggle {
            background: transparent;
            border: 2px solid var(--primary-gold);
            color: var(--bright-gold);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .collapse-toggle:hover {
            background: var(--primary-gold);
            color: var(--primary-dark);
            transform: scale(1.1);
        }
        
        /* 響應式佈局 */
        .skill-tree-container.layout-free-drag {
            /* 桌面端自由拖曳模式 */
        }
        
        .skill-tree-container.layout-constrained {
            /* 平板端限制模式 */
        }
        
        .skill-tree-container.layout-vertical {
            /* 手機端垂直模式 */
            overflow-y: auto;
            overflow-x: hidden;
            cursor: default;
        }
        
        .layout-vertical .skill-connection {
            display: none;
        }
        
        .skill-node.collapsed {
            opacity: 0 !important;
            transform: scale(0.5) translateY(-30px) !important;
            pointer-events: none;
        }
        
        /* 載入動畫 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.9);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(244, 208, 63, 0.3);
            border-top: 4px solid var(--bright-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--bright-gold);
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .loading-progress {
            color: #ccc;
            font-size: 14px;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            :root {
                --skill-size: 45px;
                --skill-spacing: 80px;
            }
            
            .info-header {
                padding: 8px 15px;
            }
            
            .info-header h1 {
                font-size: 16px;
            }
            
            .control-panel {
                position: relative;
                width: 100%;
                margin: 10px;
                max-height: none;
            }
            
            .stats-panel {
                position: relative;
                width: 100%;
                margin: 10px;
            }
            
            .skill-tree-main {
                top: 50px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            :root {
                --skill-size: 50px;
                --skill-spacing: 100px;
            }
        }
        
        /* 無障礙設計 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            :root {
                --layout-transition-duration: 0ms;
            }
        }
        
        @media (prefers-contrast: high) {
            .skill-node {
                border-width: 4px;
            }
            
            .skill-connection {
                height: 4px;
                opacity: 0.8;
            }
        }
    </style>
</head>
<body>
    <!-- 載入覆蓋層 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">初始化技能樹系統</div>
        <div class="loading-progress" id="loading-progress">載入中...</div>
    </div>

    <!-- 頂部信息欄 -->
    <div class="info-header">
        <div>
            <h1>🎮 流亡闇道風格技能樹</h1>
            <div class="version">Step 2.1 整合版本 - 完整系統</div>
        </div>
        <div class="system-status">
            <div class="status-item">
                <div class="status-indicator loading" id="status-state"></div>
                <span>狀態管理</span>
            </div>
            <div class="status-item">
                <div class="status-indicator loading" id="status-animation"></div>
                <span>動畫系統</span>
            </div>
            <div class="status-item">
                <div class="status-indicator loading" id="status-viewport"></div>
                <span>視窗控制</span>
            </div>
            <div class="status-item">
                <div class="status-indicator loading" id="status-responsive"></div>
                <span>響應式</span>
            </div>
        </div>
    </div>

    <!-- 主技能樹區域 -->
    <div class="skill-tree-main">
        <div class="skill-tree-container" id="skill-tree-container">
            <!-- 技能樹內容將由 JavaScript 動態生成 -->
        </div>
    </div>

    <!-- 控制面板 -->
    <div class="control-panel">
        <h3>🎮 技能樹控制</h3>
        
        <div class="control-group">
            <label>🖥️ 佈局模式</label>
            <div class="button-grid">
                <button class="control-button active" id="layout-desktop">桌面端</button>
                <button class="control-button" id="layout-tablet">平板端</button>
                <button class="control-button" id="layout-mobile">手機端</button>
                <button class="control-button" id="layout-auto">自動</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>🎯 視窗控制</label>
            <div class="button-grid">
                <button class="control-button" id="viewport-reset">重置</button>
                <button class="control-button" id="viewport-center">居中</button>
                <button class="control-button" id="zoom-in">放大</button>
                <button class="control-button" id="zoom-out">縮小</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>⚡ 技能操作</label>
            <div class="button-grid">
                <button class="control-button" id="skill-reset">重置技能</button>
                <button class="control-button" id="skill-random">隨機狀態</button>
                <button class="control-button" id="skill-master-all">全部精通</button>
                <button class="control-button" id="skill-lock-all">全部鎖定</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>🔧 系統工具</label>
            <div class="button-grid">
                <button class="control-button" id="animation-toggle">動畫開關</button>
                <button class="control-button" id="debug-info">調試信息</button>
                <button class="control-button" id="performance-test">效能測試</button>
                <button class="control-button" id="export-state">導出狀態</button>
            </div>
        </div>
    </div>

    <!-- 統計面板 -->
    <div class="stats-panel">
        <h3>📊 系統統計</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-label">技能總數</span>
                <span class="stat-value" id="stat-total">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">已精通</span>
                <span class="stat-value" id="stat-mastered">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">可學習</span>
                <span class="stat-value" id="stat-available">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">學習中</span>
                <span class="stat-value" id="stat-learning">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">連接線</span>
                <span class="stat-value" id="stat-connections">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">進度率</span>
                <span class="stat-value" id="stat-progress">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">當前設備</span>
                <span class="stat-value" id="stat-device">載入中</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">FPS</span>
                <span class="stat-value" id="stat-fps">60</span>
            </div>
        </div>
    </div>

    <script type="module">
        // 導入技能樹系統
        import SkillTree from './src/components/gaming/SkillTree/SkillTree.js';
        
        /**
         * 完整技能樹測試應用
         */
        class IntegratedSkillTreeTest {
            constructor() {
                this.skillTree = null;
                this.isLoading = true;
                this.animationsEnabled = true;
                this.currentMode = 'auto';
                
                // 統計數據
                this.stats = {
                    frameCount: 0,
                    startTime: Date.now(),
                    lastFpsTime: Date.now()
                };
                
                this.init();
            }
            
            async init() {
                console.log('IntegratedSkillTreeTest: 開始初始化完整技能樹系統');
                
                try {
                    // 更新載入進度
                    this.updateLoadingProgress('正在載入核心系統...');
                    
                    // 初始化技能樹
                    await this.initializeSkillTree();
                    
                    this.updateLoadingProgress('正在綁定控制器...');
                    
                    // 綁定控制器
                    this.bindControls();
                    
                    this.updateLoadingProgress('正在啟動統計系統...');
                    
                    // 啟動統計更新
                    this.startStatsUpdate();
                    
                    // 隱藏載入畫面
                    this.hideLoading();
                    
                    console.log('IntegratedSkillTreeTest: 系統初始化完成');
                    
                } catch (error) {
                    console.error('IntegratedSkillTreeTest: 初始化失敗', error);
                    this.updateLoadingProgress('初始化失敗: ' + error.message);
                }
            }
            
            async initializeSkillTree() {
                const container = document.getElementById('skill-tree-container');
                
                if (!container) {
                    throw new Error('找不到技能樹容器');
                }
                
                // 創建技能樹實例
                this.skillTree = new SkillTree(container);
                
                // 監聽初始化事件
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('技能樹初始化超時'));
                    }, 10000);
                    
                    this.skillTree.on('skill-tree-initialized', (event) => {
                        clearTimeout(timeout);
                        console.log('技能樹初始化完成:', event.data);
                        this.updateSystemStatus('state', true);
                        this.updateSystemStatus('animation', true);
                        this.updateSystemStatus('viewport', true);
                        this.updateSystemStatus('responsive', true);
                        resolve();
                    });
                    
                    this.skillTree.on('skill-tree-error', (event) => {
                        clearTimeout(timeout);
                        reject(new Error('技能樹初始化錯誤: ' + event.data.error.message));
                    });
                    
                    // 監聽其他系統事件
                    this.bindSkillTreeEvents();
                });
            }
            
            bindSkillTreeEvents() {
                if (!this.skillTree) return;
                
                // 技能點擊事件
                this.skillTree.on('skill-clicked', (event) => {
                    console.log('技能點擊:', event.data.skillId);
                });
                
                // 技能懸停事件
                this.skillTree.on('skill-hover', (event) => {
                    if (event.data.isEnter) {
                        console.log('技能懸停:', event.data.skillId);
                    }
                });
                
                // 佈局變化事件
                this.skillTree.on('layout-changed', (event) => {
                    console.log('佈局變化:', event.data);
                    this.updateLayoutButtons(event.data.mode);
                });
            }
            
            bindControls() {
                // 佈局控制
                document.getElementById('layout-desktop').addEventListener('click', () => {
                    this.setLayoutMode('desktop');
                });
                
                document.getElementById('layout-tablet').addEventListener('click', () => {
                    this.setLayoutMode('tablet');
                });
                
                document.getElementById('layout-mobile').addEventListener('click', () => {
                    this.setLayoutMode('mobile');
                });
                
                document.getElementById('layout-auto').addEventListener('click', () => {
                    this.setLayoutMode('auto');
                });
                
                // 視窗控制
                document.getElementById('viewport-reset').addEventListener('click', () => {
                    if (this.skillTree.viewportController) {
                        this.skillTree.viewportController.resetViewport();
                    }
                });
                
                document.getElementById('viewport-center').addEventListener('click', () => {
                    if (this.skillTree.viewportController) {
                        this.skillTree.viewportController.centerViewport();
                    }
                });
                
                document.getElementById('zoom-in').addEventListener('click', () => {
                    if (this.skillTree.viewportController) {
                        const container = this.skillTree.container;
                        this.skillTree.viewportController.zoomAtPoint(
                            container.clientWidth / 2,
                            container.clientHeight / 2,
                            0.2
                        );
                    }
                });
                
                document.getElementById('zoom-out').addEventListener('click', () => {
                    if (this.skillTree.viewportController) {
                        const container = this.skillTree.container;
                        this.skillTree.viewportController.zoomAtPoint(
                            container.clientWidth / 2,
                            container.clientHeight / 2,
                            -0.2
                        );
                    }
                });
                
                // 技能操作
                document.getElementById('skill-reset').addEventListener('click', () => {
                    if (this.skillTree) {
                        this.skillTree.reset();
                    }
                });
                
                document.getElementById('skill-random').addEventListener('click', () => {
                    this.randomizeSkillStates();
                });
                
                document.getElementById('skill-master-all').addEventListener('click', () => {
                    this.setAllSkillsStatus('mastered');
                });
                
                document.getElementById('skill-lock-all').addEventListener('click', () => {
                    this.setAllSkillsStatus('locked');
                });
                
                // 系統工具
                document.getElementById('animation-toggle').addEventListener('click', () => {
                    this.toggleAnimations();
                });
                
                document.getElementById('debug-info').addEventListener('click', () => {
                    this.showDebugInfo();
                });
                
                document.getElementById('performance-test').addEventListener('click', () => {
                    this.runPerformanceTest();
                });
                
                document.getElementById('export-state').addEventListener('click', () => {
                    this.exportState();
                });
            }
            
            setLayoutMode(mode) {
                this.currentMode = mode;
                
                if (!this.skillTree.responsiveAdapter) return;
                
                if (mode === 'auto') {
                    // 讓響應式適配器自動檢測
                    window.dispatchEvent(new Event('resize'));
                } else {
                    // 強制設定特定佈局
                    const layoutConfig = this.skillTree.responsiveAdapter.config.layouts[mode];
                    if (layoutConfig) {
                        this.skillTree.responsiveAdapter.applyLayout(layoutConfig, true);
                    }
                }
            }
            
            updateLayoutButtons(activeMode) {
                document.querySelectorAll('.control-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const modeMap = {
                    'free-drag': 'layout-desktop',
                    'constrained-drag': 'layout-tablet',
                    'vertical-scroll': 'layout-mobile'
                };
                
                const activeBtn = document.getElementById(modeMap[activeMode] || 'layout-auto');
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
            
            randomizeSkillStates() {
                if (!this.skillTree.stateManager) return;
                
                const skillIds = Array.from(this.skillTree.skillElements.keys());
                const states = ['locked', 'available', 'learning', 'mastered'];
                
                skillIds.forEach(skillId => {
                    const randomState = states[Math.floor(Math.random() * states.length)];
                    this.skillTree.stateManager.setSkillStatus(skillId, randomState);
                });
            }
            
            setAllSkillsStatus(status) {
                if (!this.skillTree.stateManager) return;
                
                const skillIds = Array.from(this.skillTree.skillElements.keys());
                skillIds.forEach(skillId => {
                    this.skillTree.stateManager.setSkillStatus(skillId, status);
                });
            }
            
            toggleAnimations() {
                this.animationsEnabled = !this.animationsEnabled;
                
                if (this.skillTree.animationController) {
                    this.skillTree.animationController.setAnimationsEnabled(this.animationsEnabled);
                }
                
                const button = document.getElementById('animation-toggle');
                button.textContent = this.animationsEnabled ? '動畫開啟' : '動畫關閉';
                button.classList.toggle('active', !this.animationsEnabled);
            }
            
            showDebugInfo() {
                if (!this.skillTree) return;
                
                const state = this.skillTree.getSkillTreeState();
                console.log('技能樹調試信息:', state);
                
                alert(`技能樹調試信息:\n\n` +
                    `初始化狀態: ${state.isInitialized}\n` +
                    `技能數量: ${state.skillCount}\n` +
                    `連接線數量: ${state.connectionCount}\n` +
                    `狀態統計: ${JSON.stringify(state.stateManager, null, 2)}\n` +
                    `詳細信息請查看控制台`
                );
            }
            
            runPerformanceTest() {
                console.log('開始效能測試...');
                
                const startTime = performance.now();
                let frameCount = 0;
                
                const testLoop = () => {
                    frameCount++;
                    
                    // 執行一些操作來測試效能
                    if (frameCount % 10 === 0 && this.skillTree.viewportController) {
                        const randomZoom = Math.random() * 0.02 - 0.01;
                        this.skillTree.viewportController.zoomAtPoint(
                            Math.random() * 800,
                            Math.random() * 600,
                            randomZoom
                        );
                    }
                    
                    if (frameCount < 300) { // 5秒測試
                        requestAnimationFrame(testLoop);
                    } else {
                        const duration = performance.now() - startTime;
                        const fps = (frameCount / duration) * 1000;
                        console.log(`效能測試完成: ${fps.toFixed(1)} FPS`);
                        
                        document.getElementById('stat-fps').textContent = fps.toFixed(1);
                    }
                };
                
                requestAnimationFrame(testLoop);
            }
            
            exportState() {
                if (!this.skillTree) return;
                
                const state = this.skillTree.getSkillTreeState();
                const stateJson = JSON.stringify(state, null, 2);
                
                const blob = new Blob([stateJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `skill-tree-state-${Date.now()}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            }
            
            startStatsUpdate() {
                const updateStats = () => {
                    if (!this.skillTree) return;
                    
                    try {
                        // 獲取統計數據
                        const treeState = this.skillTree.getSkillTreeState();
                        const stateStats = treeState.stateManager || {};
                        
                        // 更新統計顯示
                        document.getElementById('stat-total').textContent = 
                            treeState.skillCount || 0;
                        
                        document.getElementById('stat-mastered').textContent = 
                            stateStats.mastered || 0;
                        
                        document.getElementById('stat-available').textContent = 
                            stateStats.available || 0;
                        
                        document.getElementById('stat-learning').textContent = 
                            stateStats.learning || 0;
                        
                        document.getElementById('stat-connections').textContent = 
                            treeState.connectionCount || 0;
                        
                        // 計算進度
                        const total = stateStats.total || 1;
                        const completed = (stateStats.mastered || 0) + (stateStats.learning || 0);
                        const progress = Math.round((completed / total) * 100);
                        document.getElementById('stat-progress').textContent = `${progress}%`;
                        
                        // 設備信息
                        const device = treeState.responsive?.currentDevice || 'unknown';
                        document.getElementById('stat-device').textContent = device;
                        
                    } catch (error) {
                        console.warn('統計更新錯誤:', error);
                    }
                };
                
                // 每秒更新統計
                setInterval(updateStats, 1000);
                updateStats(); // 立即更新一次
            }
            
            updateLoadingProgress(message) {
                const progressElement = document.getElementById('loading-progress');
                if (progressElement) {
                    progressElement.textContent = message;
                }
            }
            
            updateSystemStatus(system, ready) {
                const indicator = document.getElementById(`status-${system}`);
                if (indicator) {
                    indicator.classList.remove('loading');
                    indicator.classList.add(ready ? 'ready' : '');
                }
            }
            
            hideLoading() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 500);
                }
                
                this.isLoading = false;
            }
        }
        
        // 頁面載入完成後啟動系統
        document.addEventListener('DOMContentLoaded', () => {
            window.skillTreeTest = new IntegratedSkillTreeTest();
        });
    </script>
</body>
</html>