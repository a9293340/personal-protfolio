<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MagicCircle 魔法陣組件測試</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .test-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .control-panel {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 2000;
    }

    .test-btn {
      background: linear-gradient(135deg, #d4af37, #f4d03f);
      color: #0a0a0a;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .test-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    .test-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-info {
      position: fixed;
      top: 80px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      z-index: 2000;
      max-width: 300px;
    }

    .status-info h3 {
      color: #d4af37;
      margin-bottom: 10px;
    }

    .status-item {
      margin: 5px 0;
    }

    .status-value {
      color: #4a90e2;
      font-weight: bold;
    }

    #magic-circle-display {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
    }
    
    /* 確保魔法陣容器不被裁剪 */
    .magic-circle-container {
      overflow: visible !important;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- 控制面板 -->
    <div class="control-panel">
      <button id="expand-btn" class="test-btn">展開魔法陣</button>
      <button id="collapse-btn" class="test-btn" disabled>收縮魔法陣</button>
      <button id="reset-btn" class="test-btn">重置狀態</button>
    </div>

    <!-- 狀態信息 -->
    <div class="status-info">
      <h3>🔮 魔法陣狀態</h3>
      <div class="status-item">
        階段: <span id="phase-status" class="status-value">idle</span>
      </div>
      <div class="status-item">
        可見性: <span id="visibility-status" class="status-value">false</span>
      </div>
      <div class="status-item">
        符文數量: <span id="runes-status" class="status-value">0/6</span>
      </div>
      <div class="status-item">
        動畫狀態: <span id="animation-status" class="status-value">停止</span>
      </div>
    </div>

    <!-- 魔法陣顯示區域 -->
    <div id="magic-circle-display"></div>
  </div>

  <!-- GSAP 庫 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <!-- 測試腳本 -->
  <script type="module">
    // 導入必要的組件
    import { BaseComponent } from './src/core/components/BaseComponent.js';
    import { MagicCircle } from './src/components/gaming/SummoningSystem/MagicCircle.js';

    class MagicCircleTest {
      constructor() {
        this.magicCircle = null;
        this.init();
      }

      async init() {
        console.log('🧪 [MagicCircleTest] 初始化魔法陣測試');
        
        try {
          // 創建魔法陣實例
          this.magicCircle = new MagicCircle({
            circle: {
              size: 400,
              color: '#d4af37',
              glowColor: '#f4d03f'
            },
            position: {
              x: '50%',
              y: '50%'
            }
          });

          // 初始化組件
          await this.magicCircle.init();

          // 創建元素並添加到頁面
          const element = this.magicCircle.createElement();
          document.getElementById('magic-circle-display').appendChild(element);

          // 綁定控制按鈕事件
          this.bindEvents();

          // 開始狀態監控
          this.startStatusMonitoring();

          console.log('✅ [MagicCircleTest] 測試環境準備完成');

        } catch (error) {
          console.error('❌ [MagicCircleTest] 初始化失敗:', error);
          alert('測試初始化失敗，請檢查控制台錯誤信息');
        }
      }

      bindEvents() {
        const expandBtn = document.getElementById('expand-btn');
        const collapseBtn = document.getElementById('collapse-btn');
        const resetBtn = document.getElementById('reset-btn');

        expandBtn.addEventListener('click', async () => {
          console.log('🔥 [Test] 用戶點擊展開按鈕');
          expandBtn.disabled = true;
          
          try {
            await this.magicCircle.expand();
            collapseBtn.disabled = false;
          } catch (error) {
            console.error('展開動畫失敗:', error);
          } finally {
            expandBtn.disabled = false;
          }
        });

        collapseBtn.addEventListener('click', async () => {
          console.log('💨 [Test] 用戶點擊收縮按鈕');
          collapseBtn.disabled = true;
          
          try {
            await this.magicCircle.collapse();
            expandBtn.disabled = false;
          } catch (error) {
            console.error('收縮動畫失敗:', error);
          } finally {
            collapseBtn.disabled = false;
          }
        });

        resetBtn.addEventListener('click', () => {
          console.log('🔄 [Test] 用戶點擊重置按鈕');
          this.magicCircle.reset();
          expandBtn.disabled = false;
          collapseBtn.disabled = true;
        });
      }

      startStatusMonitoring() {
        const updateStatus = () => {
          if (!this.magicCircle) return;

          const state = this.magicCircle.state;
          
          // 更新狀態顯示
          document.getElementById('phase-status').textContent = state.currentPhase;
          document.getElementById('visibility-status').textContent = state.isVisible ? 'true' : 'false';
          document.getElementById('runes-status').textContent = `${state.runesActivated}/6`;
          document.getElementById('animation-status').textContent = this.magicCircle.isAnimating ? '運行中' : '停止';
        };

        // 每500ms更新一次狀態
        setInterval(updateStatus, 500);
      }
    }

    // 等待頁面載入完成後啟動測試
    document.addEventListener('DOMContentLoaded', () => {
      new MagicCircleTest();
    });
  </script>
</body>
</html>